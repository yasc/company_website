{"version":3,"file":"admin-upload.mjs","sources":["../../../server/src/controllers/admin-upload.ts"],"sourcesContent":["import _ from 'lodash';\nimport { errors, async } from '@strapi/utils';\n\nimport type { Context } from 'koa';\n\nimport { getService } from '../utils';\nimport { ACTIONS, FILE_MODEL_UID } from '../constants';\nimport { validateBulkUpdateBody, validateUploadBody } from './validation/admin/upload';\nimport { findEntityAndCheckPermissions } from './utils/find-entity-and-check-permissions';\nimport { FileInfo } from '../types';\nimport { enforceUploadSecurity } from '../utils/mime-validation';\n\nexport default {\n  async bulkUpdateFileInfo(ctx: Context) {\n    const {\n      state: { userAbility, user },\n      request: { body },\n    } = ctx;\n\n    const { updates } = await validateBulkUpdateBody(body);\n    const uploadService = getService('upload');\n\n    const results = await async.map(\n      updates,\n      async ({ id, fileInfo }: { id: number; fileInfo: FileInfo }) => {\n        const { pm } = await findEntityAndCheckPermissions(\n          userAbility,\n          ACTIONS.update,\n          FILE_MODEL_UID,\n          id\n        );\n\n        const updated = await uploadService.updateFileInfo(id, fileInfo as any, { user });\n        return pm.sanitizeOutput(updated, { action: ACTIONS.read });\n      }\n    );\n\n    ctx.body = results;\n  },\n\n  async updateFileInfo(ctx: Context) {\n    const {\n      state: { userAbility, user },\n      query: { id },\n      request: { body },\n    } = ctx;\n\n    if (typeof id !== 'string') {\n      throw new errors.ValidationError('File id is required');\n    }\n\n    const uploadService = getService('upload');\n    const { pm } = await findEntityAndCheckPermissions(\n      userAbility,\n      ACTIONS.update,\n      FILE_MODEL_UID,\n      id\n    );\n\n    const data = await validateUploadBody(body);\n\n    const file = await uploadService.updateFileInfo(id, data.fileInfo as any, { user });\n\n    ctx.body = await pm.sanitizeOutput(file, { action: ACTIONS.read });\n  },\n\n  async replaceFile(ctx: Context) {\n    const {\n      state: { userAbility, user },\n      query: { id },\n      request: { body, files: { files } = {} },\n    } = ctx;\n\n    if (typeof id !== 'string') {\n      throw new errors.ValidationError('File id is required');\n    }\n\n    const uploadService = getService('upload');\n    const { pm } = await findEntityAndCheckPermissions(\n      userAbility,\n      ACTIONS.update,\n      FILE_MODEL_UID,\n      id\n    );\n\n    if (Array.isArray(files)) {\n      throw new errors.ApplicationError('Cannot replace a file with multiple ones');\n    }\n\n    const securityResults = await enforceUploadSecurity(files, strapi);\n\n    if (securityResults.errors.length > 0) {\n      const { error } = securityResults.errors[0];\n      switch (error.code) {\n        case 'MIME_TYPE_NOT_ALLOWED':\n          throw new errors.ValidationError(error.message, error.details);\n        default:\n          throw new errors.ApplicationError(error.message, error.details);\n      }\n    }\n\n    const data = (await validateUploadBody(body)) as { fileInfo: FileInfo };\n    const replacedFile = await uploadService.replace(\n      id,\n      { data, file: securityResults.validFiles[0] },\n      { user }\n    );\n\n    // Sign file urls for private providers\n    const signedFile = await getService('file').signFileUrls(replacedFile);\n\n    ctx.body = await pm.sanitizeOutput(signedFile, { action: ACTIONS.read });\n  },\n\n  async uploadFiles(ctx: Context) {\n    const {\n      state: { userAbility, user },\n      request: { body, files: { files } = {} },\n    } = ctx;\n\n    const uploadService = getService('upload');\n    const pm = strapi.service('admin::permission').createPermissionsManager({\n      ability: userAbility,\n      action: ACTIONS.create,\n      model: FILE_MODEL_UID,\n    });\n\n    if (!pm.isAllowed) {\n      return ctx.forbidden();\n    }\n\n    const securityResults = await enforceUploadSecurity(files, strapi);\n\n    if (securityResults.validFiles.length === 0) {\n      throw new errors.ValidationError(\n        securityResults.errors[0].error.message,\n        securityResults.errors[0].error.details\n      );\n    }\n\n    let filteredBody = body;\n    if (body?.fileInfo && Array.isArray(body.fileInfo)) {\n      const filteredFileInfo = body.fileInfo.filter((fi: string) => {\n        const info = typeof fi === 'string' ? JSON.parse(fi) : fi;\n        return securityResults.validFileNames.includes(info.name);\n      });\n\n      if (filteredFileInfo.length === 1) {\n        filteredBody = {\n          ...body,\n          fileInfo: filteredFileInfo[0],\n        };\n      } else {\n        filteredBody = {\n          ...body,\n          fileInfo: filteredFileInfo,\n        };\n      }\n    }\n\n    const isMultipleFiles =\n      Array.isArray(filteredBody.fileInfo) && filteredBody.fileInfo.length > 1;\n\n    const data = await validateUploadBody(filteredBody, isMultipleFiles);\n\n    let filesArray = securityResults.validFiles;\n\n    if (\n      data.fileInfo &&\n      Array.isArray(data.fileInfo) &&\n      filesArray.length === data.fileInfo.length\n    ) {\n      // Reorder filesArray to match data.fileInfo order\n      const alignedFilesArray = data.fileInfo\n        .map((info) => {\n          return filesArray.find((file) => file.originalFilename === info.name);\n        })\n        .filter(Boolean) as any[];\n\n      filesArray = alignedFilesArray;\n    }\n\n    // Upload files first to get thumbnails\n    const uploadedFiles = await uploadService.upload({ data, files: filesArray }, { user });\n    if (uploadedFiles.some((file) => file.mime?.startsWith('image/'))) {\n      await getService('metrics').trackUsage('didUploadImage');\n    }\n\n    const aiMetadataService = getService('aiMetadata');\n\n    // AFTER upload - use thumbnail versions for AI processing\n    if (await aiMetadataService.isEnabled()) {\n      try {\n        // Use thumbnail URLs instead of original files\n        const thumbnailFiles = uploadedFiles.map(\n          (file) =>\n            ({\n              filepath: file.formats?.thumbnail?.url || file.url, // Use thumbnail if available\n              mimetype: file.mime,\n              originalFilename: file.name,\n              size: file.formats?.thumbnail?.size || file.size,\n              provider: file.provider,\n            }) as unknown as any\n        );\n\n        const metadataResults = await aiMetadataService.processFiles(thumbnailFiles);\n\n        // Update the uploaded files with AI metadata\n        await Promise.all(\n          uploadedFiles.map(async (uploadedFile, index) => {\n            const aiMetadata = metadataResults[index];\n            if (aiMetadata) {\n              await uploadService.updateFileInfo(\n                uploadedFile.id,\n                {\n                  alternativeText: aiMetadata.altText,\n                  caption: aiMetadata.caption,\n                },\n                { user }\n              );\n\n              uploadedFiles[index].alternativeText = aiMetadata.altText;\n              uploadedFiles[index].caption = aiMetadata.caption;\n            }\n          })\n        );\n      } catch (error) {\n        strapi.log.warn('AI metadata generation failed, proceeding without AI enhancements', {\n          error: error instanceof Error ? error.message : String(error),\n        });\n      }\n    }\n\n    // Sign file urls for private providers\n    const signedFiles = await async.map(uploadedFiles, getService('file').signFileUrls);\n\n    ctx.body = await pm.sanitizeOutput(signedFiles, { action: ACTIONS.read });\n    ctx.status = 201;\n  },\n\n  // TODO: split into multiple endpoints\n  async upload(ctx: Context) {\n    const {\n      query: { id },\n      request: { files: { files } = {} },\n    } = ctx;\n\n    if (_.isEmpty(files) || (!Array.isArray(files) && files.size === 0)) {\n      if (id) {\n        return this.updateFileInfo(ctx);\n      }\n\n      throw new errors.ApplicationError('Files are empty');\n    }\n\n    await (id ? this.replaceFile : this.uploadFiles)(ctx);\n  },\n};\n"],"names":["bulkUpdateFileInfo","ctx","state","userAbility","user","request","body","updates","validateBulkUpdateBody","uploadService","getService","results","async","map","id","fileInfo","pm","findEntityAndCheckPermissions","ACTIONS","update","FILE_MODEL_UID","updated","updateFileInfo","sanitizeOutput","action","read","query","errors","ValidationError","data","validateUploadBody","file","replaceFile","files","Array","isArray","ApplicationError","securityResults","enforceUploadSecurity","strapi","length","error","code","message","details","replacedFile","replace","validFiles","signedFile","signFileUrls","uploadFiles","service","createPermissionsManager","ability","create","model","isAllowed","forbidden","filteredBody","filteredFileInfo","filter","fi","info","JSON","parse","validFileNames","includes","name","isMultipleFiles","filesArray","alignedFilesArray","find","originalFilename","Boolean","uploadedFiles","upload","some","mime","startsWith","trackUsage","aiMetadataService","isEnabled","thumbnailFiles","filepath","formats","thumbnail","url","mimetype","size","provider","metadataResults","processFiles","Promise","all","uploadedFile","index","aiMetadata","alternativeText","altText","caption","log","warn","Error","String","signedFiles","status","_","isEmpty"],"mappings":"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"}